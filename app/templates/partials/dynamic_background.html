<div x-data="dynamicBackground()" class="fixed inset-0 z-0 pointer-events-none overflow-hidden bg-gray-900"
     x-show="style !== 'NONE'">

    <template x-if="['HERO', 'HYBRID'].includes(style) && imageUrl">
        <div class="absolute inset-0 bg-cover bg-center transition-opacity duration-700"
             :style="`background-image: url('${imageUrl}'); opacity: 0.5; filter: blur(3px) brightness(0.4); transform: scale(1.1);`">
        </div>
    </template>

    <template x-if="['COLORSCAPE', 'HYBRID'].includes(style)">
        <div class="absolute inset-0 transition-opacity duration-700"
             :class="style === 'HYBRID' ? 'opacity-70 mix-blend-overlay' : 'opacity-90'"
             :style="gradientStyle">
        </div>
    </template>

<div class="absolute inset-0"
     style="background: linear-gradient(to bottom,
         rgba(17, 24, 39, 0.3) 0%,
         rgba(17, 24, 39, 0.5) 50%,
         rgba(17, 24, 39, 0.7) 100%);">
</div>
</div>

<script>
function dynamicBackground() {
    return {
        style: 'NONE', // NONE, HERO, COLORSCAPE, HYBRID
        primary: '#000000',
        secondary: '#1a1a1a',
        imageUrl: '',

        async init() {

            if(!window.PAGE_CONTEXT)
            {
                this.style = 'NONE';
                return;
            }

            // 1. Fetch System Setting
            // In a real app, you might inject this via backend template to avoid a fetch
            // But fetching ensures we respect user changes immediately
            const settingRes = await fetch(window.url('/api/settings/'));
            if(settingRes.ok) {
                const settings = await settingRes.json();
                // Find ui.background_style
                const styleSetting = settings.appearance.find(s => s.key === 'ui.background_style');
                console.log(styleSetting);
                this.style = styleSetting ? styleSetting.value : 'NONE';
            }

            // 2. Read Context from the Page
            // The parent page (comic_detail, series_detail) must expose these variables globally
            this.primary = window.PAGE_CONTEXT.colors?.primary || '#000000';
            this.secondary = window.PAGE_CONTEXT.colors?.secondary || '#1a1a1a';
            this.imageUrl = window.PAGE_CONTEXT.imageUrl || '';

        },

        get gradientStyle() {
            // Mesh Gradient style (Top-Left -> Bottom-Right)
            return `background: radial-gradient(circle at 0% 0%, ${this.primary} 0%, transparent 50%),
                                radial-gradient(circle at 100% 0%, ${this.secondary} 0%, transparent 50%),
                                linear-gradient(to bottom, #111827 0%, #000 100%);`;
        }
    }
}
</script>